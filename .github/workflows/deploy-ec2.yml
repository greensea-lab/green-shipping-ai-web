name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Build production
        run: npm run build:prod
        env:
          CI: false

      - name: Create deployment package
        run: |
          cd build
          tar -czf ../deploy.tar.gz .
          cd ..
          echo "ğŸ“¦ ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„± ì™„ë£Œ"

      - name: Deploy to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "deploy.tar.gz"
          target: "/home/ubuntu/app"

      - name: Execute deployment commands on EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /home/ubuntu/app
            
            echo "ğŸ”„ ë°°í¬ ì‹œì‘..."
            
            # ë°±ì—… ìƒì„±
            if [ -d "/var/www/green-shipping-ai-web" ]; then
              BACKUP_DIR="/var/www/green-shipping-ai-web.backup.$(date +%Y%m%d_%H%M%S)"
              echo "ğŸ’¾ ë°±ì—… ìƒì„±: $BACKUP_DIR"
              sudo cp -r /var/www/green-shipping-ai-web $BACKUP_DIR
              
              # ì˜¤ë˜ëœ ë°±ì—… ì‚­ì œ (7ì¼ ì´ìƒ)
              sudo find /var/www -name "green-shipping-ai-web.backup.*" -mtime +7 -exec rm -rf {} \; 2>/dev/null || true
            fi
            
            # ë°°í¬ ë””ë ‰í† ë¦¬ ìƒì„±
            sudo mkdir -p /var/www/green-shipping-ai-web
            
            # ì„ì‹œ ë””ë ‰í† ë¦¬ ì •ë¦¬ ë° ìƒì„± (sudo ì‚¬ìš©)
            echo "ğŸ—‘ï¸  ê¸°ì¡´ ì„ì‹œ ë””ë ‰í† ë¦¬ ì •ë¦¬..."
            sudo rm -rf /tmp/green-shipping-deploy
            mkdir -p /tmp/green-shipping-deploy
            
            # íŒŒì¼ ì••ì¶• í•´ì œ
            echo "ğŸ“‚ íŒŒì¼ ì••ì¶• í•´ì œ ì¤‘..."
            tar -xzf deploy.tar.gz -C /tmp/green-shipping-deploy
            
            echo "ğŸ“‹ ì••ì¶• í•´ì œëœ íŒŒì¼ í™•ì¸..."
            ls -la /tmp/green-shipping-deploy/
            
            # íŒŒì¼ ë³µì‚¬
            echo "ğŸ“‹ íŒŒì¼ ë³µì‚¬ ì¤‘..."
            sudo rm -rf /var/www/green-shipping-ai-web/*
            sudo cp -r /tmp/green-shipping-deploy/* /var/www/green-shipping-ai-web/
            
            # ê¶Œí•œ ì„¤ì • (403 ì—ëŸ¬ ë°©ì§€)
            echo "ğŸ”’ ê¶Œí•œ ì„¤ì • ì¤‘..."
            sudo chown -R www-data:www-data /var/www/green-shipping-ai-web
            sudo chmod -R 755 /var/www/green-shipping-ai-web
            
            # íŒŒì¼ ê¶Œí•œ í™•ì¸
            echo "âœ… ë°°í¬ëœ íŒŒì¼ í™•ì¸:"
            ls -lh /var/www/green-shipping-ai-web/ | head -5
            
            # index.html ì¡´ì¬ í™•ì¸
            if [ -f "/var/www/green-shipping-ai-web/index.html" ]; then
              echo "âœ… index.html íŒŒì¼ ì¡´ì¬"
            else
              echo "âŒ index.html íŒŒì¼ ì—†ìŒ!"
              exit 1
            fi
            
            # Nginx ì¬ì‹œì‘
            echo "ğŸ”„ Nginx ì¬ì‹œì‘ ì¤‘..."
            sudo systemctl reload nginx
            
            # ì„ì‹œ íŒŒì¼ ì •ë¦¬
            rm -rf /tmp/green-shipping-deploy
            rm deploy.tar.gz
            
            echo "âœ… ë°°í¬ ì™„ë£Œ!"

      - name: Health check
        timeout-minutes: 2
        continue-on-error: false
        run: |
          echo "ğŸ¥ Health Check ì‹œì‘..."
          echo "ğŸŒ ëŒ€ìƒ URL: ${{ secrets.APP_URL }}"
          echo ""
          
          # ìµœëŒ€ 30ì´ˆ ë™ì•ˆ ì¬ì‹œë„
          MAX_ATTEMPTS=6
          ATTEMPT=0
          SUCCESS=false
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ”„ ì‹œë„ $ATTEMPT/$MAX_ATTEMPTS"
            
            # HTTP ìƒíƒœ ì½”ë“œ í™•ì¸
            HTTP_CODE=$(curl -s --max-time 5 -o /dev/null -w "%{http_code}" ${{ secrets.APP_URL }} || echo "000")
            echo "ğŸ“¡ HTTP ìƒíƒœ ì½”ë“œ: $HTTP_CODE"
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… ì„œë²„ ì‘ë‹µ ì •ìƒ (HTTP 200)"
              
              # React ì•± í™•ì¸
              echo "ğŸ” React ì•± í™•ì¸ ì¤‘..."
              if curl -s --max-time 5 ${{ secrets.APP_URL }} | grep -q '<div id="root">'; then
                echo "âœ… React ì•± ë¡œë“œ í™•ì¸"
                SUCCESS=true
                break
              else
                echo "âš ï¸  HTMLì€ ë¡œë“œë˜ì—ˆì§€ë§Œ React root divë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ"
              fi
            else
              echo "âŒ ì„œë²„ ì‘ë‹µ ì‹¤íŒ¨ (HTTP $HTTP_CODE)"
            fi
            
            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              echo "â³ 5ì´ˆ í›„ ì¬ì‹œë„..."
              sleep 5
            fi
          done
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          if [ "$SUCCESS" = true ]; then
            echo "ğŸ‰ Health Check í†µê³¼!"
            exit 0
          else
            echo "âŒ Health Check ì‹¤íŒ¨ (30ì´ˆ íƒ€ì„ì•„ì›ƒ)"
            echo ""
            echo "ğŸ” ë””ë²„ê¹… ì •ë³´:"
            echo "1. EC2 ì¸ìŠ¤í„´ìŠ¤ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”"
            echo "2. Nginxê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”: sudo systemctl status nginx"
            echo "3. íŒŒì¼ì´ ë°°í¬ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”: ls -la /var/www/green-shipping-ai-web"
            echo "4. Nginx ì—ëŸ¬ ë¡œê·¸: sudo tail -50 /var/log/nginx/error.log"
            exit 1
          fi

      - name: Deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "================================================"
            echo "âœ… ë°°í¬ ì„±ê³µ!"
            echo "================================================"
            echo "ğŸŒ URL: ${{ secrets.APP_URL }}"
            echo "â° ë°°í¬ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')"
            echo "ğŸ‰ ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼"
            echo "================================================"
          else
            echo "================================================"
            echo "âŒ ë°°í¬ ì‹¤íŒ¨"
            echo "================================================"
            echo "GitHub Actions ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ íŒŒì•…í•˜ì„¸ìš”"
            echo "================================================"
          fi
