name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Build production
        run: npm run build:prod
        env:
          CI: false

      - name: Create deployment package
        run: |
          cd build
          tar -czf ../deploy.tar.gz .
          cd ..
          echo "ğŸ“¦ ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„± ì™„ë£Œ"

      - name: Deploy to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "deploy.tar.gz"
          target: "/home/ubuntu/app"

      - name: Execute deployment commands on EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /home/ubuntu/app
            
            echo "ğŸ”„ ë°°í¬ ì‹œì‘..."
            
            # ë°±ì—… ìƒì„±
            if [ -d "/var/www/green-shipping-ai-web" ]; then
              BACKUP_DIR="/var/www/green-shipping-ai-web.backup.$(date +%Y%m%d_%H%M%S)"
              echo "ğŸ’¾ ë°±ì—… ìƒì„±: $BACKUP_DIR"
              sudo cp -r /var/www/green-shipping-ai-web $BACKUP_DIR
              
              # ì˜¤ë˜ëœ ë°±ì—… ì‚­ì œ (7ì¼ ì´ìƒ)
              sudo find /var/www -name "green-shipping-ai-web.backup.*" -mtime +7 -exec rm -rf {} \; 2>/dev/null || true
            fi
            
            # ë°°í¬ ë””ë ‰í† ë¦¬ ìƒì„±
            sudo mkdir -p /var/www/green-shipping-ai-web
            sudo mkdir -p /tmp/green-shipping-deploy
            
            # íŒŒì¼ ì••ì¶• í•´ì œ ë° ë³µì‚¬
            echo "ğŸ“‚ íŒŒì¼ ì••ì¶• í•´ì œ ì¤‘..."
            tar -xzf deploy.tar.gz -C /tmp/green-shipping-deploy
            
            echo "ğŸ“‹ íŒŒì¼ ë³µì‚¬ ì¤‘..."
            sudo rm -rf /var/www/green-shipping-ai-web/*
            sudo cp -r /tmp/green-shipping-deploy/* /var/www/green-shipping-ai-web/
            
            # ê¶Œí•œ ì„¤ì •
            echo "ğŸ”’ ê¶Œí•œ ì„¤ì • ì¤‘..."
            sudo chown -R www-data:www-data /var/www/green-shipping-ai-web
            sudo chmod -R 755 /var/www/green-shipping-ai-web
            
            # Nginx ì¬ì‹œì‘
            echo "ğŸ”„ Nginx ì¬ì‹œì‘ ì¤‘..."
            sudo systemctl reload nginx
            
            # ì„ì‹œ íŒŒì¼ ì •ë¦¬
            rm -rf /tmp/green-shipping-deploy
            rm deploy.tar.gz
            
            echo "âœ… ë°°í¬ ì™„ë£Œ!"

      - name: Wait for server
        run: |
          echo "â³ ì„œë²„ ì¤€ë¹„ ëŒ€ê¸° ì¤‘..."
          sleep 10

      - name: Health check
        run: |
          echo "ğŸ¥ Health Check ì‹œì‘..."
          
          # ê¸°ë³¸ ì—°ê²° í…ŒìŠ¤íŠ¸
          if curl -f -s -o /dev/null -w "%{http_code}" ${{ secrets.APP_URL }} | grep -q "200"; then
            echo "âœ… ì„œë²„ ì‘ë‹µ ì •ìƒ (HTTP 200)"
          else
            echo "âŒ ì„œë²„ ì‘ë‹µ ì‹¤íŒ¨"
            exit 1
          fi
          
          # HTML ì»¨í…ì¸  í™•ì¸
          if curl -s ${{ secrets.APP_URL }} | grep -q '<div id="root">'; then
            echo "âœ… React ì•± ë¡œë“œ í™•ì¸"
          else
            echo "âŒ React ì•± ë¡œë“œ ì‹¤íŒ¨"
            exit 1
          fi
          
          # ì‘ë‹µ ì‹œê°„ ì¸¡ì •
          response_time=$(curl -o /dev/null -s -w '%{time_total}' ${{ secrets.APP_URL }})
          echo "â±ï¸  ì‘ë‹µ ì‹œê°„: ${response_time}ì´ˆ"
          
          echo "ğŸ‰ Health Check í†µê³¼!"

      - name: Deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "================================================"
            echo "âœ… ë°°í¬ ì„±ê³µ!"
            echo "================================================"
            echo "ğŸŒ URL: ${{ secrets.APP_URL }}"
            echo "â° ë°°í¬ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')"
            echo "ğŸ‰ ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼"
            echo "================================================"
          else
            echo "================================================"
            echo "âŒ ë°°í¬ ì‹¤íŒ¨"
            echo "================================================"
            echo "GitHub Actions ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ íŒŒì•…í•˜ì„¸ìš”"
            echo "================================================"
          fi
